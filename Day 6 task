from pyspark.sql import functions as F

# Read both months and union
oct_raw = spark.read.csv("/Volumes/workspace/ecommerce/ecommerce_data/2019-Oct.csv", header=True, inferSchema=True)
nov_raw = spark.read.csv("/Volumes/workspace/ecommerce/ecommerce_data/2019-Nov.csv", header=True, inferSchema=True)
raw = oct_raw.unionByName(nov_raw)

# Add ingestion timestamp and write to Bronze
raw.withColumn("ingestion_ts", F.current_timestamp()) \
   .write.format("delta").mode("overwrite") \
   .save("/Volumes/workspace/ecommerce/ecommerce_data/bronze_events")



  from pyspark.sql import functions as F

bronze = spark.read.format("delta").load("/Volumes/workspace/ecommerce/ecommerce_data/bronze_events")

# Data cleaning: remove rows with nulls in critical columns and filter out invalid price values
silver = (
    bronze
    .filter(F.col("price").isNotNull())
    .filter(F.col("event_time").isNotNull())
    .filter(F.col("user_session").isNotNull())
    .filter(F.col("price") > 0)
    .filter(F.col("price") < 10000)
    .dropDuplicates(["user_session", "event_time"])
    .withColumn("event_date", F.to_date("event_time"))
    .withColumn(
        "price_tier",
        F.when(F.col("price") < 10, "budget")
         .when(F.col("price") < 50, "mid")
         .otherwise("premium")
    )
)

silver.write.format("delta").mode("overwrite").save("/Volumes/workspace/ecommerce/ecommerce_data/silver_events")






  from pyspark.sql import functions as F

bronze = spark.read.format("delta").load("/Volumes/workspace/ecommerce/ecommerce_data/bronze_events")

# Aggregate product KPIs: total sales, average price, order count per product
gold = (
    bronze
    .filter(F.col("price").isNotNull())
    .filter(F.col("product_id").isNotNull())
    .groupBy("product_id")
    .agg(
        F.count("*").alias("order_count"),
        F.sum("price").alias("total_sales"),
        F.avg("price").alias("avg_price"),
        F.max("price").alias("max_price"),
        F.min("price").alias("min_price")
    )
)

gold.write.format("delta").mode("overwrite").save("/Volumes/workspace/ecommerce/ecommerce_data/gold_product_kpis")
display(gold)



  
